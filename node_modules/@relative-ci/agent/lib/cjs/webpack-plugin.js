'use strict';

var webpack = require('webpack');
var merge = require('lodash/merge');
var validate = require('@bundle-stats/plugin-webpack-validate');
var en = require('./locales/en.js');
var debug = require('./utils/debug.js');
var filterArtifacts = require('./utils/filter-artifacts.js');
require('child_process');
var getEnvVars = require('./utils/get-env-vars.js');
var logResponse = require('./utils/log-response.js');
require('lodash/set');
require('lodash/get');
var constants = require('./constants.js');
var normalizeParams = require('./utils/normalize-params.js');
var ingest = require('./ingest.js');

const PLUGIN_NAME = 'RelativeCiAgent';
const DEFAULT_OPTIONS = {
    includeCommitMessage: true,
    payloadFilepath: null,
    stats: {
        assets: true,
        chunks: true,
        modules: true,
    },
};
const isWebpack5 = parseInt(webpack.version, 10) === 5;
async function sendStats(compilation, options) {
    const { stats: statsOptions, failOnError, ...config } = options;
    const data = compilation.getStats().toJson(statsOptions);
    const logger = compilation.compiler?.getInfrastructureLogger
        ? compilation.compiler.getInfrastructureLogger(PLUGIN_NAME)
        : console;
    try {
        // @ts-expect-error incorrect type export
        const invalidData = validate.default(data);
        if (invalidData) {
            throw new Error(en.VALIDATE_ERROR);
        }
        const params = normalizeParams.normalizeParams({}, config);
        const artifactsData = filterArtifacts.filterArtifacts([{ key: constants.SOURCE_WEBPACK_STATS, data }]);
        const response = await ingest.default(artifactsData, params, config, logger);
        logResponse.logResponse(response);
    }
    catch (error) {
        if (failOnError) {
            compilation.errors.push(error);
        }
        else {
            logger.warn(error); // catch error to prevent failure on error
        }
    }
}
class RelativeCiAgentWebpackPlugin {
    constructor(options) {
        this.options = options;
    }
    apply(compiler) {
        const { isCi } = getEnvVars.getEnvVars();
        const options = merge({}, DEFAULT_OPTIONS, {
            enabled: isCi,
        }, this.options);
        debug.debug(options);
        // Skip if not enabled
        if (!options.enabled) {
            debug.debug(`${PLUGIN_NAME} is disabled, skip sending data`);
            return;
        }
        if (isWebpack5) {
            compiler.hooks.make.tap(PLUGIN_NAME, (compilation) => {
                compilation.hooks.processAssets.tap({ name: PLUGIN_NAME, stage: webpack.Compilation.PROCESS_ASSETS_STAGE_REPORT }, () => sendStats(compilation, options));
            });
            return;
        }
        compiler.hooks.emit.tapAsync(PLUGIN_NAME, async (compilation, callback) => {
            await sendStats(compilation, options);
            callback();
        });
    }
}

exports.RelativeCiAgentWebpackPlugin = RelativeCiAgentWebpackPlugin;
//# sourceMappingURL=webpack-plugin.js.map
